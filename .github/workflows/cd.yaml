name: Core Service - Continuous Deployment

on:
  push:
    branches: ["master"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Obter AWS Account ID
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "ACCOUNT_ID=$ACCOUNT_ID" >> $GITHUB_ENV

      - name: Login no ECR
        run: |
          aws ecr get-login-password --region us-east-1 \
            | docker login --username AWS --password-stdin $ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com

      - name: Buscar URL do banco de dados
        id: db_secret
        run: |
          DB_URL=$(aws secretsmanager get-secret-value \
            --secret-id golunch/db-url \
            --query SecretString \
            --output text)
          echo "db_url=$DB_URL" >> $GITHUB_OUTPUT

      - name: Debug valor DB_URL
        run: echo "DB_URL capturado ${{ steps.db_secret.outputs.db_url }}"

      - name: Build da imagem
        run: |
          IMAGE_TAG=${GITHUB_SHA}
          docker build -t golunch-core-service:${IMAGE_TAG} .
          docker tag golunch-core-service:${IMAGE_TAG} $ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/golunch-core-service:${IMAGE_TAG}
          docker push $ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/golunch-core-service:${IMAGE_TAG}

      - name: Configurar kubectl para o EKS
        run: |
          aws eks update-kubeconfig --region us-east-1 --name eks-golunch-terraform-infra

      - name: Criar Secret manualmente
        env:
          DB_USER: ${{ secrets.DATABASE_USER }}
          DB_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
          DB_HOST: ${{ steps.db_secret.outputs.db_url }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          kubectl delete secret core-service-secrets --ignore-not-found
          kubectl create secret generic core-service-secrets \
            --from-literal=DATABASE_URL="postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:5432/golunch_core?sslmode=require" \
            --from-literal=SECRET_KEY="$SECRET_KEY" \
            --from-literal=PAYMENT_SERVICE_URL="http://payment-service:8082" \
            --from-literal=OPERATION_SERVICE_URL="http://operation-service:8083"

      - name: Instalar ou atualizar release com Helm
        run: |
          IMAGE_TAG=${GITHUB_SHA}
          helm upgrade --install golunch-core-service ./goLunch \
            --set image.repository=$ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/golunch-core-service \
            --set image.tag=${IMAGE_TAG} \
            --set app.service_port=8081 \
            --set app.secret_key="${{ secrets.SECRET_KEY }}"

      - name: Obter URL do serviço (LoadBalancer)
        run: |
          echo "⏳ Aguardando LoadBalancer atribuir EXTERNAL-IP..."
          for i in {1..30}; do
            SERVICE_URL=$(kubectl get svc golunch-core-service -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null)
            if [ -n "$SERVICE_URL" ]; then
              echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV
              echo "✅ Encontrado: $SERVICE_URL"
              exit 0
            fi
            echo "Ainda aguardando... ($i/30)"
            sleep 10
          done
          echo "❌ Não foi possível obter EXTERNAL-IP"
          exit 1

      - name: Deploy com Helm (configmap atualizado)
        run: |
          IMAGE_TAG=${GITHUB_SHA}
          helm upgrade --install golunch-core-service ./goLunch \
            --set image.repository=$ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/golunch-core-service \
            --set image.tag=${IMAGE_TAG} \
            --set app.publicURL="http://${SERVICE_URL}:8081" \
            --set app.service_port=8081

      - name: Atualizando pods
        run: |
          kubectl rollout restart deployment golunch-core-service 
